<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="http://192.168.0.6/favicon2.png">
    <title>DKS DPMS 3D WEB VIEWER</title>
</head>

<body>
<canvas id="c"></canvas>
<canvas id="c2"></canvas>
</body>

<script type="importmap">
  {
    "imports": {
      "three": "http://192.168.0.6/node_modules/three/build/three.module.js",
	  "three/addons/": "http://192.168.0.6/node_modules/three/examples/jsm/"
    }
  }
</script>

<script type="module">
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
 

  // 센서 데이터 가져오기
  const sensorData = getSensorData()

  // SCENE 생성
  const scene = new THREE.Scene();
  const canvas = document.getElementById('c');
  const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);

  // 카메라 추가
  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 0, 50)
  scene.add(camera);

  // 카메라 클릭 제어
  const controls = new OrbitControls(camera, canvas);
  controls.target.set(0, 0, 0);
  controls.update();

  // 선택된 Sensor ID 가져오기
  let id = 0;
  const params = getUrlParams()
  if (params.hasOwnProperty('sensorId')) {
    const paramVal = Number(params['sensorId'])
    if ( paramVal < sensorData.length) {
      id = paramVal;
    }
  }

  // 선택된 Sensor 포커징
  camPos(camera, sensorData[id].camPos.x, sensorData[id].camPos.y, sensorData[id].camPos.z);
  camera.lookAt(sensorData[id].sensorPos.x, sensorData[id].sensorPos.y, sensorData[id].sensorPos.z);
  controls.target.set(sensorData[id].sensorPos.x, sensorData[id].sensorPos.y, sensorData[id].sensorPos.z);
  controls.update();

  // 센서 박스 만들기
  try {
    if (sensorData.length == 1) { throw new Error("Has no sensor data.") }
    sensorData.forEach((datum, index) => {
      if (index != 0) {
        const boxScale = 0.02;
        const pickColor = 0xff0000;
        const baseColor = 0xffbfbf;
        var sensor;
        if (id == Number(datum.id)) {
          sensor = makeSensorInstance(boxScale, pickColor, datum.sensorPos.x, datum.sensorPos.y, datum.sensorPos.z)
        } else {
          sensor = makeSensorInstance(boxScale, baseColor, datum.sensorPos.x, datum.sensorPos.y, datum.sensorPos.z)
        }
        scene.add(sensor)
      }
    })
  } catch(e) {
    console.log(e);
  }

  // 조명 추가
  const color = 0xFFFFFF;
  const intensity = 1;
  const light = new THREE.DirectionalLight(color, intensity);
  const light2 = new THREE.DirectionalLight(color, intensity);
  light.position.set(-25, -80, -5);
  light2.position.set(-7, 19, 4);
  scene.add(light);
  scene.add(light2);

  // GRID 추가
  const size = 50;
  const divisions = 6;
  const gridHelper = new THREE.GridHelper(size, divisions);
  gridHelper.position.set(16,1,18)
  gridHelper.rotation.x = Math.PI/2;
  // scene.add(gridHelper);

  // AXIS 좌표계 추가
  const scene2 = new THREE.Scene();
  const canvas2 = document.getElementById('c2');
  const renderer2 = new THREE.WebGLRenderer({ canvas: canvas2, alpha: true });
  renderer2.setSize(160, 160);
  const camera2 = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
  const axes2 = new THREE.AxesHelper(150);
  // camera2.up = camera.up;
  scene2.add(axes2);

  // loadGltfModel('dpmsModel_deck', '#f0f0f0', 0.4, false)
  // loadGltfModel('dpmsModel_equi', '#6885ab', 0.7, false)
  loadGltfModel('dpmsModelForRIMS', '#edbe2f', 0.7, false)

  animate()

  function getSensorData() {
    const sensorData = [
      {
        id: 'default',
        sensorPos: { x: -3.7, y: -3, z: 2.3 },
        camPos: { x: -3.7, y: -5, z: 2.3 }
      },
      {
        id: '001',
        sensorPos: { x: -3.263, y: -3.128, z: 2.561 },
        camPos: { x: -3.263, y: -5.128, z: 2.561 },
      },
      {
        id: '002',
        sensorPos: { x: -3.62, y: -3.128, z: 2.67 },
        camPos: { x: -3.62, y: -5.128, z: 2.67 },
      },
      {
        id: '003',
        sensorPos: { x: -3.667, y: -3.128, z: 2.311 },
        camPos: { x: -3.667, y: -5.128, z: 2.311 },
      },
      {
        id: '004',
        sensorPos: { x: -3.561, y: -3.128, z: 1.954 },
        camPos: { x: -3.561, y: -5.128, z: 1.954 },
      },
      {
        id: '005',
        sensorPos: { x: -3.915, y: -3.128, z: 1.910 },
        camPos: { x: -3.915, y: -5.128, z: 1.910 },
      }
    ]
    return sensorData
  }

  function loadGltfModel(fileName, color, alpha, isWireFrame) {
    const loader = new GLTFLoader();
    const fName = fileName;
    const modelUrl = 'http://192.168.0.6/' + fName + '.gltf';

    loader.load(modelUrl, function (gltf) {
      var object = gltf.scene;
      object.traverse((node) => {
        if (!node.isMesh) return;
        node.material.wireframe = isWireFrame;
        node.material.transparent = true;
        node.material.opacity = alpha;

        if (node.material.name != null && node.material.name == "") {
          node.material.color.set(color)
        }
      });
      scene.add(object);
    }, undefined, function (error) {
      console.error(error);
    });
  }

  function camPos(cam, x, y, z) {
    cam.position.set(x, y, z)
  }

  function makeSensorInstance(boxScale, color, x, y, z) {
    const geometry = new THREE.BoxGeometry(boxScale, boxScale, boxScale);
    const material = new THREE.MeshPhongMaterial({color});
    const box = new THREE.Mesh(geometry, material);

    box.position.x = x;
    box.position.y = y;
    box.position.z = z;

    return box;
  }

  function getUrlParams() {
    var params = {};

    window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,
      function(str, key, value) {
          params[key] = value;
        }
    );

    return params;
  }

  function animate() {
    requestAnimationFrame(animate);

    // console.log(camera.position)

    camera2.position.copy(camera.position);
    camera2.position.sub(controls.target); // added by @libe
    camera2.position.setLength(100);
    camera2.lookAt(scene2.position);

    renderer.render(scene, camera);
    renderer2.render(scene2, camera2);
  }
</script>

<style>
  html, body {
    margin: 0;
    height: 100%;
  }
  #c {
    width: 100%;
    height: 100%;
    display: block;
    background: radial-gradient(#ffffff, #353535);
  }
  #c2 {
    position: absolute;
    left: 4vw;
    bottom: 4vw;
    width: 160px;
    height: 160px;
    display: block;
    float: left;
    background: radial-gradient(#ffffff, #000000);
    border: solid 1px #333333;
    border-radius: 50%;
    z-index: 100;
    box-shadow: 2px 2px 2px 1px rgba(0, 0, 0, 0.2);
  }
</style>

</html>
